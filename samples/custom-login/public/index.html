<html>
  <head>
    <!-- https://global.oktacdn.com/okta-auth-js/4.0.0/okta-auth-js.polyfill.js -->
    <script src="/okta-auth-js.polyfill.js" type="text/javascript"></script>

    <!-- https://global.oktacdn.com/okta-auth-js/4.0.0/okta-auth-js.min.js -->
    <script src="/okta-auth-js.min.js" type="text/javascript"></script>

    <!-- signin widget -->
    <script src="https://global.oktacdn.com/okta-signin-widget/4.4.3/js/okta-sign-in.min.js" type="text/javascript"></script>
    <link href="https://global.oktacdn.com/okta-signin-widget/4.4.3/css/okta-sign-in.min.css" type="text/css" rel="stylesheet"/>


  </head>
  <body>
    <div id="form" style="display: none">
      <style>
        input[type=text] {
          width: 600px;
        }
      </style>
      <form target="/" method="GET">
        <label for="issuer">Issuer</label><input id="issuer" name="issuer" type="text" /><br/>
        <label for="clientId">Client ID</label><input id="clientId" name="clientId" type="text" /><br/>
        <hr/>
        <input id="login-submit" type="submit" value="Update Config"/>
      </form>
    </div>
    <div id="unauth" style="display: none">
      <b>Please login</b><hr/>
      <div id="signin-widget"></div>
    </div>
    <div id="auth" style="display: none">
      <b>Welcome back</b><hr/>
      <div id="userinfo"></div><hr/>
      <a id="logout" href=#" onclick="logout(event)">Logout</a>
    </div>
    <div id="error" style="color: red; padding-top: 20px">
    </div>
    <hr/>
    <a href="/">Return Home</a>
    <script type="text/javascript">
      var authClient;
      var issuer;
      var clientId;
      var redirectUri = window.location.origin + window.location.pathname; // http://localhost:8080/static/

      var url = new URL(window.location.href);
      var state = url.searchParams.get('state');
      var error = url.searchParams.get('error');
      if (state) {
        state = JSON.parse(state);
        issuer = state.issuer;
        clientId = state.clientId;
      } else {
        issuer = url.searchParams.get('issuer');
        clientId = url.searchParams.get('clientId');
      }

      var appUrl = window.location.origin + window.location.pathname +
        '?issuer=' + encodeURIComponent(issuer) + 
        '&clientId=' + encodeURIComponent(clientId);
      
      main();

      function main() {

        var hasValidConfig = (issuer && clientId);
        if (!hasValidConfig) {
          document.getElementById('form').style.display = 'block';
          return;
        }

        try {
          authClient = new OktaAuth({
            issuer: issuer,
            clientId: clientId,
            redirectUri: redirectUri,
            tokenManager: {
              storage: 'memory'
            }
          });
        } catch (error) {
          return showError(error);
        }

        if (error === 'login_required') {
          return showLogin();
        }

        if (authClient.token.isLoginRedirect()) {
          return handleLoginRedirect();
        }

        showUserInfo();
      }

      function onLoggedIn(res) {
        // Store tokens (in memory)
        authClient.tokenManager.add('idToken', res.tokens.idToken);
        authClient.tokenManager.add('accessToken', res.tokens.accessToken);

        document.getElementById('unauth').style.display = 'none';

        showUserInfo();
      }

      function handleLoginRedirect() {
        authClient.token.parseFromUrl().then(function(res) {
          history.replaceState(null, '', appUrl); // parseFromUrl clears location.search
          onLoggedIn(res);
        });
      }
    
      function showError(error) {
        console.error(error);
        var node = document.createElement('DIV');
        node.innerText = JSON.stringify(error, null, 2);
        document.getElementById('error').appendChild(node);
      }
  
      function showUserInfo() {
        return Promise.all([
          authClient.tokenManager.get('idToken'),
          authClient.tokenManager.get('accessToken')
        ])
        .then(function(values) {
          var idToken = values[0];
          var accessToken = values[1];
          if (!idToken || !accessToken) {
            return redirectToGetTokens();
          }
          authClient.token.getUserInfo().then(function(userInfo) {
            document.getElementById('auth').style.display = 'block';
            document.getElementById('userinfo').innerText = JSON.stringify(userInfo, null, 2);
          }).catch(function(error) {
            showError(error);
            showLogin();
          });
        });
      }

      function showLogin() {
        var signIn = new OktaSignIn({
          baseUrl: issuer.split('oauth2')[0],
          clientId,
          redirectUri,
          authParams: {
            issuer,
            state: JSON.stringify({
              issuer: issuer,
              clientId: clientId
            }),
          }
        });

        signIn.renderEl(
          { el: '#signin-widget' },
          function success(res) {
            console.log('login success', res);

            if (res.status === 'SUCCESS') {
              history.replaceState(null, '', appUrl); // remove error from location.search
              onLoggedIn(res);
            }
          },
          function error(err) {
            console.log('login error', err);
          }
        );

        document.getElementById('unauth').style.display = 'block';
      }

      function redirectToGetTokens() {
        authClient.token.getWithRedirect({
          state: JSON.stringify({
            issuer: issuer,
            clientId: clientId
          }),
          prompt: 'none' // do not show Okta hosted login page, instead redirect back with error
        });
      };
  
      function logout(e) {
        e.preventDefault();
        authClient.signOut()
      }
  
    </script>
  </body>
</html>